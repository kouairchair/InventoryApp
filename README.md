# うちの在庫
[AppStore：うちの在庫](https://apple.co/3WgrZLX)

## 1.概要
このアプリは家庭の食品や日用品など様々な物を管理するためのアプリです。

賞味期限が近いことを通知したり、買い物リストを作成して必要なものを買い忘れないようにすることができます。

iCloudに対応しているので、同じアカウントでログインしているデバイス間でデータを共有することができます。

## 2.機能
### 商品登録
#### データ作成・登録画面
<kbd><img src="https://user-images.githubusercontent.com/53589421/213456867-c4c32a3b-1e56-4db0-a3f2-0aa30b33d538.PNG" /></kbd>
<kbd><img src="https://user-images.githubusercontent.com/53589421/213458614-37a3814c-0d5e-473c-a436-cb9957581a6f.PNG" /></kbd>

- "作成"ボタンで空のデータを生成し、それを編集することでデータを作成する。（最大10個）

- バーコードのアイコンを押すとバーコードリーダーが起動し、読み取った商品の名前と画像が入ったデータが作成される。

- "登録"ボタンを押して、作成したデータをデータベースに保存する。

- 商品名が入力されていないデータは登録できない。

#### データ編集画面
<kbd><img src="https://user-images.githubusercontent.com/53589421/213616197-88ceaeee-3963-4ce7-b0c5-862dc52c8a34.PNG" /></kbd>

- 各項目はボタンやアイコンを押すことで設定できる。

- 画面上部のピッカーで在庫リスト・買い物リストどちらに属するデータなのかを決める。

- "画像を設定する"ボタンのある行をタップすると画像を設定する方法を選択できる。
  - バーコード検索：バーコード検索で取得した画像と商品名をデータに代入する。
  - 自分で撮影：カメラ撮影した画像を正方形にトリミングして使用する。
  - サンプル画像を選択：イラスト画像を使用する。

- "期限"を設定した場合のみ"通知"の日時を設定できるようになる。"通知"の日時を指定してデータを保存するとローカル通知が作成される。

#### バーコードリーダー
データ作成画面で呼び出す場合とデータ編集画面で呼び出す場合で挙動が変わる

- データ作成画面
  - 取得した画像と商品名を最大10セットまで保持して、新たな商品データを作成する。
  
  <kbd><img src="https://user-images.githubusercontent.com/53589421/213483691-614d7b66-8210-4072-ac44-3f6a87861266.PNG" /></kbd>

- データ編集画面
  - 取得した画像と商品名はバーコードを読み取るたびに更新され、編集中のデータを書き換える。
  
  <kbd><img src="https://user-images.githubusercontent.com/53589421/213484271-d2c65943-0c77-4609-8a79-f038058221f4.PNG" /></kbd>

### データ管理
#### フォルダ画面
"編集"ボタンを押すと編集モードになり、新規フォルダ作成や既存のフォルダの編集・削除が行える。

<kbd><img src="https://user-images.githubusercontent.com/53589421/213615623-ac26f46a-fa44-4847-9218-5779ca9fac69.PNG" /></kbd>
<kbd><img src="https://user-images.githubusercontent.com/53589421/213615786-859b650b-7bf1-4a72-8da9-6d65bbff2871.PNG" /></kbd>

#### データリスト
タップして詳細を確認、編集できる。削除は左スワイプのみ。

<kbd><img src="https://user-images.githubusercontent.com/53589421/213616495-da698691-3f54-4704-8abf-3f2cf8016f6a.PNG" /></kbd>

- リストの並び
  - 在庫リスト：期限が早い順に並ぶ。過ぎている期限は赤く表示される。
  - 買い物リスト：緊急性が高いものが上に、通常のものは下になる。
  
- データ確認・編集
  - データ作成時とほぼ同じ画面。右上の"編集"ボタンを押すと編集モードになり、"完了"ボタンを押すと終了する。データを更新すると"登録日"も更新される。

### アプリの設定確認

<kbd><img src="https://user-images.githubusercontent.com/53589421/213615390-d4f1f3db-54da-470b-ad6a-06d8caca8c1d.PNG" /></kbd>

 - アプリの機能に関わる権限を確認できる。実際に設定を変更する場合は"設定アプリを開く"を押して行う。
 
 - "通知の再設定"ボタンを押すとすべてのローカル通知を削除してから、現在より後の時間に指定されているローカル通知のみを作成する。その際、通知日が過ぎているデータは通知を"無し"に更新される。

### ローカル通知
![ローカル通知](https://user-images.githubusercontent.com/53589421/213625456-13795e77-d68a-4b93-91e6-606715bd8a00.jpeg)

通知日程を設定したデータが登録された時に作成されるローカル通知には、そのデータが更新された時に同時に更新される。
通知日程を無しの状態に更新された場合は、作成されたローカル通知を削除する。
また、クラウドの変更を受け取った際にローカル通知も自動で更新・削除される。

## 3.データベースの設計

### CoreDataモデル

エンティティFolderとItemのリレーションシップ

- Folder

| 属性 | 型 | 概要 |
----|----|----
| name | String | フォルダ名 |
| id | UUID | フォルダの識別ID |
| icon | String | フォルダのアイコンの名前 |
| isStock | Boolean | true = 在庫リスト, false = 買い物リスト |
| items | Item | フォルダ内のアイテムデータ。 1対多のリレーションシップ |

- Item

| 属性 | 型 | 概要 |
----|----|----
| name | String | 商品名 |
| id | UUID | データの識別ID |
| image | Binary Data | 画像データ |
| numberOfItems | Integer 16 | 個数 |
| registrationDate | Date | 登録・更新された日付 |
| deadLine | Date | 賞味期限・使用期限の日付（在庫リストのみ） |
| notificationDate | Date | 期限が近いことを知らせる通知の日付（在庫リストのみ） |
| status | String | 在庫の状態。"未開封"・"開封済み"・"残りわずか"を選択する（在庫リストのみ） |
| isHurry | Boolean | 買い物の緊急性。"緊急"・"通常"を選択する（買い物リストのみ） |
| folder | Folder | 所属しているフォルダ。 1対1のリレーションシップ |

### CloudKit
#### NSPersistentCloudKitContainer
iCloudアカウントが使用可能な場合にCoreDataに登録したデータはクラウドデータベースに保存される。
クラウドからの変更を自動取得して適用する。その際、データが重複しないよう外部変更はメモリ内を置き換える。

#### CKQuerySubscription
クラウドの商品データの変更を検知し、サイレント通知を受け取る。通知で受け取った値を元に各デバイスのローカル通知を更新する。

##### サイレント通知で取得する商品データ

| 属性 | 概要 |
----|----
| "CD_name" | 商品名 |
| "CD_id" | データの識別ID |
| "CD_notificationDate" | データに設定された期限のローカル通知の日付 |

##### 通知イベント
CKQueryNotification.Reasonの値によってクラウドの変更を追加・更新・削除に判別する。
- 追加・更新の場合の処理
  - 取得したデータにローカル通知の日付がnilでないならローカル通知を作成。
  - nilの場合はIDが一致するローカル通知があれば削除する。
 
- 削除の場合の処理
  - IDが一致するローカル通知があれば削除する。

## 4.開発環境
- Xcode 14.2
- macOS Ventura 13.1
- iOS16.0
- CoreData + CloudKit

## 5.画像素材
[フリーイラスト素材集 ジャパクリップ](https://japaclip.com/)

[かわいいフリー素材集　いらすとや](https://www.irasutoya.com/)
